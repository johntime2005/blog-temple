---
import { getCollection } from "astro:content";
import PostCard from "@/components/PostCard.astro";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { isPostInColumn } from "@/utils/column-utils";
import { getPostUrlBySlug } from "@/utils/url-utils";

// 获取所有教程文章
// 方式1：使用栏目系统（推荐）- 匹配 category 为 "博客教程"、"博客指南"、"文章示例" 的文章
// 方式2：或者在 tutorials 目录下的文章
const allPosts = await getCollection("posts", ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});

// 定义教程相关的栏目/分类
const tutorialCategories = ["博客教程", "博客指南", "文章示例"];

// 过滤出教程文章
const tutorialPosts = allPosts.filter((post) => {
	// 方式1：检查是否属于教程相关栏目
	for (const category of tutorialCategories) {
		if (isPostInColumn(post, category)) {
			return true;
		}
	}

	// 方式2：检查文章路径是否在 tutorials 目录下
	if (post.id.startsWith("tutorials/")) {
		return true;
	}

	return false;
});

// 按发布日期排序（新文章在前）
const sortedTutorials = tutorialPosts.sort((a, b) => {
	// 优先按置顶排序
	if (a.data.pinned && !b.data.pinned) return -1;
	if (!a.data.pinned && b.data.pinned) return 1;

	// 然后按发布日期排序
	return b.data.published.valueOf() - a.data.published.valueOf();
});

const title = "教程";
const subtitle = "博客主题使用教程和技术文章";
---

<MainGridLayout title={title} description={subtitle}>
	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div class="card-base z-10 px-9 py-6 relative w-full">
			<!-- 页面标题 -->
			<div class="flex flex-col items-start justify-center mb-8">
				<h1
					class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2"
				>
					{title}
				</h1>
				<p class="text-lg text-black/60 dark:text-white/60">
					{subtitle}
				</p>
				<div class="mt-4 text-sm text-black/50 dark:text-white/50">
					共 {sortedTutorials.length} 篇教程
				</div>
			</div>

			<!-- 教程文章列表 -->
			<div class="space-y-6">
				{
					sortedTutorials.map((post, index) => (
						<div
							class="onload-animation"
							style={`animation-delay: ${index * 50}ms`}
						>
							<PostCard
								entry={post}
								title={post.data.title}
								url={getPostUrlBySlug(post.id)}
								published={post.data.published}
								updated={post.data.updated}
								tags={post.data.tags}
								category={post.data.category}
								image={post.data.image}
								description={post.data.description}
								draft={post.data.draft}
								pinned={post.data.pinned}
							/>
						</div>
					))
				}
			</div>

			<!-- 如果没有教程文章 -->
			{
				sortedTutorials.length === 0 && (
					<div class="text-center py-12 text-black/60 dark:text-white/60">
						<p class="text-lg">暂无教程文章</p>
						<p class="text-sm mt-2">
							请将文章放在 tutorials 目录下，或设置 category 为
							"博客教程"、"博客指南" 或 "文章示例"
						</p>
					</div>
				)
			}
		</div>
	</div>
</MainGridLayout>
