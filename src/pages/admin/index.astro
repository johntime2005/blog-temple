---

---

<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex" />
        <style>
            /* 弹窗提示样式 */
            .popup-notice {
                display: none;
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                font-size: 14px;
                max-width: 90%;
                text-align: center;
            }
            .popup-notice.show {
                display: block;
                animation: slideDown 0.3s ease-out;
            }
            @keyframes slideDown {
                from {
                    transform: translateX(-50%) translateY(-20px);
                    opacity: 0;
                }
                to {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
            }
            .popup-notice button {
                margin-top: 10px;
                background: white;
                color: #667eea;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s;
            }
            .popup-notice button:hover {
                background: #f0f0f0;
                transform: scale(1.05);
            }

            /* 加载指示器 */
            #cms-loader {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #fff;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                font-family: -apple-system, system-ui, sans-serif;
            }
            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            #error-message {
                display: none;
                color: #e53e3e;
                margin-top: 20px;
                text-align: center;
                max-width: 80%;
            }
        </style>
        <title>博客管理后台 - Content Manager</title>
        <link
            rel="icon"
            type="image/png"
            href="/favicon/favicon-light-32.png"
        />
    </head>
    <body>
        <!-- 加载状态 -->
        <div id="cms-loader">
            <div class="spinner"></div>
            <div>正在加载管理后台...</div>
            <div id="error-message">
                加载时间过长，请检查网络连接或刷新页面。<br />
                如果一直显示此消息，请尝试清除浏览器缓存。
            </div>
        </div>

        <!-- 弹窗阻止提示 -->
        <div id="popupNotice" class="popup-notice">
            ⚠️ 浏览器阻止了登录弹窗！<br />
            请在地址栏右侧点击弹窗图标，允许弹窗后重试<br />
            或者<br />
            <button onclick="window.location.href='/auth'">直接跳转登录</button>
        </div>

        <!-- Decap CMS 挂载点 -->
        <div id="nc-root"></div>

        <!-- React 环境 (用于自定义预览) - 本地托管 (Cloudflare CDN 加速) -->
        <script is:inline src="/admin/scripts/react.production.min.js"></script>
        <script is:inline src="/admin/scripts/react-dom.production.min.js"
        ></script>

        <!-- Decap CMS 核心脚本 - 本地托管 (Cloudflare CDN 加速) -->
        <script is:inline src="/admin/scripts/decap-cms.js"></script>

        <!-- 自定义预览模板和样式注册 -->
        <script is:inline>
            // 错误超时检测 - 延长到 20 秒
            const loaderTimeout = setTimeout(() => {
                const errorMsg = document.getElementById("error-message");
                if (errorMsg && !window.CMS) {
                    errorMsg.style.display = "block";
                }
            }, 30000);

            // 等待 CMS 对象加载
            const interval = setInterval(() => {
                if (window.CMS && window.React && window.ReactDOM) {
                    clearInterval(interval);
                    clearTimeout(loaderTimeout);

                    // 隐藏加载器
                    const loader = document.getElementById("cms-loader");
                    if (loader) loader.style.display = "none";

                    try {
                        initCMS();
                    } catch (e) {
                        console.error(
                            "Failed to initialize CMS custom previews:",
                            e,
                        );
                    }
                }
            }, 100);

            function initCMS() {
                const CMS = window.CMS;
                const React = window.React;
                const h = React.createElement;
                const { useEffect } = React;

                console.log("Initializing CMS preview templates...");

                // 定义文章预览组件
                const PostPreview = (props) => {
                    if (!props.entry) return null;

                    const entry = props.entry;
                    const title = entry.getIn(["data", "title"]) || "";
                    const date = entry.getIn(["data", "published"]);
                    const image = entry.getIn(["data", "image"]);
                    const description = entry.getIn(["data", "description"]);
                    const tags = entry.getIn(["data", "tags"]);

                    const renderTags = () => {
                        if (!tags) return null;
                        const tagsArray =
                            tags && typeof tags.toJS === "function"
                                ? tags.toJS()
                                : tags;
                        if (Array.isArray(tagsArray)) {
                            return tagsArray.map((tag) =>
                                h(
                                    "span",
                                    {
                                        key: tag,
                                        className:
                                            "px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full mr-2 mb-2 inline-block text-xs",
                                    },
                                    tag,
                                ),
                            );
                        }
                        return null;
                    };

                    useEffect(() => {
                        try {
                            const iframe =
                                document.querySelector("#nc-root iframe");
                            const doc = iframe
                                ? iframe.contentDocument ||
                                  iframe.contentWindow.document
                                : document;
                            if (
                                doc &&
                                !doc.getElementById("tailwind-preview-script")
                            ) {
                                const script = doc.createElement("script");
                                script.id = "tailwind-preview-script";
                                script.src =
                                    "https://cdn.tailwindcss.com?plugins=typography";
                                doc.head.appendChild(script);
                            }
                        } catch (e) {
                            console.warn(
                                "Failed to inject Tailwind into preview",
                                e,
                            );
                        }
                    }, []);

                    let dateStr = "";
                    try {
                        dateStr = date
                            ? new Date(date).toLocaleDateString("zh-CN", {
                                  year: "numeric",
                                  month: "long",
                                  day: "numeric",
                              })
                            : "";
                    } catch (e) {
                        console.warn("Date formatting error", e);
                    }

                    return h(
                        "div",
                        {
                            className:
                                "bg-white dark:bg-gray-900 min-h-screen p-8 shadow-inner",
                        },
                        h(
                            "div",
                            { className: "max-w-3xl mx-auto" },
                            image &&
                                h("img", {
                                    src: props.getAsset(image).toString(),
                                    className:
                                        "w-full h-64 md:h-96 object-cover rounded-xl shadow-lg mb-8",
                                }),
                            h(
                                "h1",
                                {
                                    className:
                                        "text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4",
                                },
                                title,
                            ),
                            h(
                                "div",
                                {
                                    className:
                                        "flex flex-wrap gap-2 text-gray-500 dark:text-gray-400 text-sm mb-8",
                                },
                                h("span", {}, dateStr),
                                h(
                                    "div",
                                    { className: "flex flex-wrap" },
                                    renderTags(),
                                ),
                            ),
                            description &&
                                h(
                                    "div",
                                    {
                                        className:
                                            "text-xl text-gray-600 dark:text-gray-300 italic mb-8 pl-4 border-l-4 border-blue-500",
                                    },
                                    description,
                                ),
                            h(
                                "div",
                                {
                                    className:
                                        "prose prose-lg dark:prose-invert max-w-none",
                                },
                                props.widgetFor("body"),
                            ),
                        ),
                    );
                };

                CMS.registerPreviewTemplate("posts", PostPreview);
                CMS.registerPreviewTemplate("tutorials", PostPreview);
                CMS.registerPreviewTemplate("wordpress-posts", PostPreview);

                console.log("CMS Preview Templates Registered Successfully");
            }
        </script>

        <script is:inline>
            // 弹窗阻止检测
            (() => {
                const originalOpen = window.open;
                window.open = function (...args) {
                    const popup = originalOpen.apply(this, args);
                    if (
                        !popup ||
                        popup.closed ||
                        typeof popup.closed === "undefined"
                    ) {
                        const notice = document.getElementById("popupNotice");
                        if (notice) {
                            notice.classList.add("show");
                            setTimeout(
                                () => notice.classList.remove("show"),
                                10000,
                            );
                        }
                    }
                    return popup;
                };
            })();
        </script>
    </body>
</html>
