---

---

<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex" />
        <style>
            /* 弹窗提示样式 */
            .popup-notice {
                display: none;
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                font-size: 14px;
                max-width: 90%;
                text-align: center;
            }
            .popup-notice.show {
                display: block;
                animation: slideDown 0.3s ease-out;
            }
            @keyframes slideDown {
                from {
                    transform: translateX(-50%) translateY(-20px);
                    opacity: 0;
                }
                to {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
            }
            .popup-notice button {
                margin-top: 10px;
                background: white;
                color: #667eea;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s;
            }
            .popup-notice button:hover {
                background: #f0f0f0;
                transform: scale(1.05);
            }
        </style>
        <title>博客管理后台 - Content Manager</title>
        <link
            rel="icon"
            type="image/png"
            href="/favicon/favicon-light-32.png"
        />
    </head>
    <body>
        <!-- 弹窗阻止提示 -->
        <div id="popupNotice" class="popup-notice">
            ⚠️ 浏览器阻止了登录弹窗！<br />
            请在地址栏右侧点击弹窗图标，允许弹窗后重试<br />
            或者<br />
            <button onclick="window.location.href='/auth'">直接跳转登录</button>
        </div>

        <!-- React & ReactDOM (Decap CMS 需要 React 环境来渲染自定义预览) -->
        <script
            is:inline
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            is:inline
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>

        <!-- Decap CMS 核心脚本 -->
        <script
            is:inline
            src="https://cdn.jsdelivr.net/npm/decap-cms@^3.0.0/dist/decap-cms.js"
        ></script>

        <!-- 自定义预览模板和样式注册 -->
        <script is:inline>
            // 等待 CMS 和 React 对象加载
            const interval = setInterval(() => {
                // 确保 CMS、React 和 ReactDOM 都已加载
                if (window.CMS && window.React && window.ReactDOM) {
                    clearInterval(interval);
                    // 稍微延迟一下确保一切就绪
                    setTimeout(() => {
                        try {
                            initCMS();
                        } catch (e) {
                            console.error(
                                "Failed to initialize CMS custom previews:",
                                e,
                            );
                        }
                    }, 100);
                }
            }, 100);

            function initCMS() {
                const CMS = window.CMS;
                const React = window.React;
                const h = React.createElement;
                const { useState, useEffect } = React;

                console.log("Initializing CMS preview templates...");

                // 定义文章预览组件
                const PostPreview = (props) => {
                    // 防御性编程：确保 entry 存在
                    if (!props.entry) return null;

                    const entry = props.entry;
                    const title = entry.getIn(["data", "title"]) || "";
                    const date = entry.getIn(["data", "published"]);
                    const body = entry.getIn(["data", "body"]) || "";
                    const image = entry.getIn(["data", "image"]);
                    const description = entry.getIn(["data", "description"]);
                    const tags = entry.getIn(["data", "tags"]);

                    // 安全地处理 tags 映射
                    const renderTags = () => {
                        if (!tags) return null;

                        // 尝试转换为数组 (Immutable.js -> Array)
                        // Decap CMS 使用 Immutable.js Map/List
                        const tagsArray =
                            tags && typeof tags.toJS === "function"
                                ? tags.toJS()
                                : tags;

                        if (Array.isArray(tagsArray)) {
                            return tagsArray.map((tag) =>
                                h(
                                    "span",
                                    {
                                        key: tag,
                                        className:
                                            "px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full",
                                    },
                                    tag,
                                ),
                            );
                        }
                        return null;
                    };

                    // 在预览组件挂载时注入 Tailwind CSS
                    useEffect(() => {
                        try {
                            // 尝试获取预览 iframe 的 document
                            const iframe =
                                document.querySelector("#nc-root iframe");
                            const doc = iframe
                                ? iframe.contentDocument ||
                                  iframe.contentWindow.document
                                : document;

                            if (
                                doc &&
                                !doc.getElementById("tailwind-preview-script")
                            ) {
                                const script = doc.createElement("script");
                                script.id = "tailwind-preview-script";
                                script.src =
                                    "https://cdn.tailwindcss.com?plugins=typography";
                                doc.head.appendChild(script);
                            }
                        } catch (e) {
                            console.warn(
                                "Failed to inject Tailwind into preview",
                                e,
                            );
                        }
                    }, []);

                    // 格式化日期
                    let dateStr = "";
                    try {
                        dateStr = date
                            ? new Date(date).toLocaleDateString("zh-CN", {
                                  year: "numeric",
                                  month: "long",
                                  day: "numeric",
                              })
                            : "";
                    } catch (e) {
                        console.warn("Date formatting error", e);
                    }

                    return h(
                        "div",
                        {
                            className:
                                "bg-white dark:bg-gray-900 min-h-screen p-8",
                        },
                        h(
                            "div",
                            { className: "max-w-3xl mx-auto" },
                            // 封面图
                            image &&
                                h("img", {
                                    src: props.getAsset(image).toString(),
                                    className:
                                        "w-full h-64 md:h-96 object-cover rounded-xl shadow-lg mb-8",
                                }),
                            // 标题
                            h(
                                "h1",
                                {
                                    className:
                                        "text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4",
                                },
                                title,
                            ),
                            // 元信息
                            h(
                                "div",
                                {
                                    className:
                                        "flex flex-wrap gap-4 text-gray-500 dark:text-gray-400 text-sm mb-8",
                                },
                                h("span", {}, dateStr),
                                h(
                                    "div",
                                    { className: "flex gap-2" },
                                    renderTags(),
                                ),
                            ),
                            // 简介
                            description &&
                                h(
                                    "div",
                                    {
                                        className:
                                            "text-xl text-gray-600 dark:text-gray-300 italic mb-8 pl-4 border-l-4 border-blue-500",
                                    },
                                    description,
                                ),
                            // 正文 (使用 widgetFor 渲染 Markdown)
                            h(
                                "div",
                                {
                                    className:
                                        "prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-blue-500 hover:prose-a:text-blue-600 prose-img:rounded-lg",
                                },
                                props.widgetFor("body"),
                            ),
                        ),
                    );
                };

                // 注册预览模板到各个集合
                CMS.registerPreviewTemplate("posts", PostPreview);
                CMS.registerPreviewTemplate("tutorials", PostPreview);
                CMS.registerPreviewTemplate("wordpress-posts", PostPreview);

                console.log("CMS Preview Templates Registered Successfully");
            }
        </script>

        <script is:inline>
            // 弹窗阻止检测
            (() => {
                const originalOpen = window.open;
                window.open = function (...args) {
                    const popup = originalOpen.apply(this, args);

                    // 检查弹窗是否被阻止
                    if (
                        !popup ||
                        popup.closed ||
                        typeof popup.closed === "undefined"
                    ) {
                        const notice = document.getElementById("popupNotice");
                        if (notice) {
                            notice.classList.add("show");
                            setTimeout(
                                () => notice.classList.remove("show"),
                                10000,
                            );
                        }
                    }

                    return popup;
                };
            })();
        </script>
    </body>
</html>
