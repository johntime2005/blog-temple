---
import Layout from "@layouts/Layout.astro";
import UnifiedAdmin from "@components/admin/UnifiedAdmin.svelte";

import { getCategoryConfigFromContent } from "@/config/categoryConfig";
import { getCollection } from "astro:content";

const categoryConfig = await getCategoryConfigFromContent();

const allPosts = await getCollection("posts", ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});

const postCountMap: Record<string, number> = {};
for (const post of allPosts) {
	const category = post.data.category?.trim() || "未分类";
	postCountMap[category] = (postCountMap[category] || 0) + 1;
}

const categoriesWithStats = Object.values(categoryConfig).map((cat) => ({
	id: cat.id,
	name: cat.name,
	slug: cat.slug,
	icon: cat.icon,
	description: cat.description,
	showInHome: cat.showInHome,
	showInNavbar: cat.showInNavbar || false,
	syncToPublic: cat.syncToPublic || false,
	encrypted: cat.encrypted || false,
	order: cat.order,
	color: cat.color,
	customLink: cat.customLink,
	postCount: postCountMap[cat.name] || 0,
}));

const postsData = allPosts.map((post) => ({
	slug: post.id,
	title: post.data.title,
	published: post.data.published.toISOString(),
	encrypted: post.data.encrypted || false,
	encryptionId: post.data.encryptionId || "",
	category: post.data.category || "",
	tags: post.data.tags || [],
}));
---

<Layout title="管理后台" description="统一管理后台">
	<div class="admin-container">
		<UnifiedAdmin
			client:load
			categories={categoriesWithStats}
			posts={postsData}
		/>
	</div>
</Layout>

<style>
	.admin-container {
		min-height: 100vh;
		background: var(--page-bg);
	}
</style>
