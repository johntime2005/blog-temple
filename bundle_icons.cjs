const fs = require("node:fs");
const path = require("node:path");

const targetIcons = [
	"wb-sunny-outline-rounded",
	"dark-mode-outline-rounded",
	"brightness-auto-outline-rounded",
	"image-outline",
	"wallpaper",
	"hide-image-outline",
];

const sourcePath = path.resolve(
	__dirname,
	"node_modules/@iconify-json/material-symbols/icons.json",
);
const outputPath = path.resolve(__dirname, "src/utils/icon-bundle.ts");

try {
	const rawData = fs.readFileSync(sourcePath, "utf8");
	const sourceData = JSON.parse(rawData);

	const bundleData = {
		prefix: sourceData.prefix,
		icons: {},
		aliases: {},
	};

	targetIcons.forEach((name) => {
		// Remove prefix if present
		const cleanName = name.replace("material-symbols:", "");

		// Check if it's an alias
		if (sourceData.aliases?.[cleanName]) {
			bundleData.aliases[cleanName] = sourceData.aliases[cleanName];
			// Resolve parent
			const parent = sourceData.aliases[cleanName].parent;
			if (sourceData.icons[parent]) {
				bundleData.icons[parent] = sourceData.icons[parent];
			} else {
				console.warn(`Parent icon ${parent} for alias ${cleanName} not found.`);
			}
		} else if (sourceData.icons[cleanName]) {
			bundleData.icons[cleanName] = sourceData.icons[cleanName];
		} else {
			console.warn(`Icon ${cleanName} not found in source.`);
		}
	});

	const fileContent = `/**
 * This file is verified to be auto-generated by bundle_icons.cjs
 * Do not modify manually.
 */
import { addCollection } from '@iconify/svelte';

const data = ${JSON.stringify(bundleData, null, 2)};

addCollection(data);
`;

	fs.writeFileSync(outputPath, fileContent);
	console.log(`Icon bundle generated at ${outputPath}`);
} catch (error) {
	console.error("Error generating icon bundle:", error);
	process.exit(1);
}
